!function(e){"function"==typeof define&&define.amd?define(e):e()}((function(){"use strict";function openUploadModalDialog(){$(".upload").off("click.lsuploadquestion"),$(".upload").on("click.lsuploadquestion",(function(e){e.preventDefault();$(this);var t=getQueryVariable("show_title",this.href),a=getQueryVariable("show_comment",this.href),n=getQueryVariable("pos",this.href),i=getQueryVariable("fieldname",this.href);({})[uploadLang.returnTxt]=function(){$(this).dialog("close")},$("#file-upload-modal-"+i).modal("show"),$(document).off("shown.bs.modal.lsuploadquestion"),$(document).on("shown.bs.modal.lsuploadquestion","#file-upload-modal-"+i,(function(){var e=$("#uploader"+i);e.load(e.data("src")),updateMaxHeightModalbody($(this))})),$("#file-upload-modal-"+i).off("hide.bs.modal.lsuploadquestion"),$("#file-upload-modal-"+i).on("hide.bs.modal.lsuploadquestion",(function(){window.currentUplaodHandler.saveAndExit(i,t,a,n),$("#uploader"+i).html("")}))}))}function updateMaxHeightModalbody(e){var t=$(e).find(".modal-header").outerHeight(),a=$(e).find(".modal-footer").outerHeight();console.ls.log([$(window).height(),t,a,t+a]);var n=Math.max(150,$(window).height()-(t+a+16));$(e).find(".modal-body").css("max-height",n)}function getQueryVariable(e,t){for(var a=t.split("/"),n=0;n<a.length;n++)if(a[n]==e)return a[n+1];for(a=t.replace(/\&amp;/g,"&").split("&"),n=0;n<a.length;n++){var i=a[n].split("=");if(i[0]==e)return i[1]}return null}function isValueInArray(e,t){for(inArray=!1,i=0;i<e.length;i++)t.toLowerCase()==e[i].toLowerCase()&&(inArray=!0);return inArray}!function(){function addEvent(e,t,a){if(e.addEventListener)e.addEventListener(t,a,!1);else{if(!e.attachEvent)throw new Error("not supported or DOM not loaded");e.attachEvent("on"+t,(function(){a.call(e)}))}}if(document.documentElement.getBoundingClientRect)var getOffset=function(e){var t=e.getBoundingClientRect(),a=e.ownerDocument,n=a.body,i=a.documentElement,l=i.clientTop||n.clientTop||0,o=i.clientLeft||n.clientLeft||0,s=1;if(n.getBoundingClientRect){var r=n.getBoundingClientRect();s=(r.right-r.left)/n.clientWidth}return s>1&&(l=0,o=0),{top:t.top/s+(window.pageYOffset||i&&i.scrollTop/s||n.scrollTop/s)-l,left:t.left/s+(window.pageXOffset||i&&i.scrollLeft/s||n.scrollLeft/s)-o}};else var getOffset=function(e){var t=0,a=0;do{t+=e.offsetTop||0,a+=e.offsetLeft||0,e=e.offsetParent}while(e);return{left:a,top:t}};function getBox(e){var t,a,n=getOffset(e);return t=n.left,a=n.top,{left:t,right:t+e.offsetWidth,top:a,bottom:a+e.offsetHeight}}function addStyles(e,t){for(var a in t)t.hasOwnProperty(a)&&(e.style[a]=t[a])}function copyLayout(e,t){var a=getBox(e);addStyles(t,{position:"absolute",left:a.left+"px",top:a.top+"px",width:e.offsetWidth+"px",height:e.offsetHeight+"px"})}var toElement=(div=document.createElement("div"),function(e){div.innerHTML=e;var t=div.firstChild;return div.removeChild(t)}),div,getUID=(id=0,function(){return"ValumsAjaxUpload"+id++}),id;function fileFromPath(e){return e.replace(/.*(\/|\\)/,"")}function getExt(e){return-1!==(e=e.toLowerCase()).indexOf(".")?e.replace(/.*[.]/,""):""}function hasClass(e,t){return new RegExp("\\b"+t+"\\b").test(e.className)}function addClass(e,t){hasClass(e,t)||(e.className+=" "+t)}function removeClass(e,t){var a=new RegExp("\\b"+t+"\\b");e.className=e.className.replace(a,"")}function removeNode(e){e.parentNode.removeChild(e)}window.AjaxUpload=function(e,t){for(var a in this._settings={action:"upload.php",name:"userfile",multiple:!1,data:{},autoSubmit:!0,responseType:!1,hoverClass:"hover",focusClass:"focus",disabledClass:"disabled",onChange:function(e,t){},onSubmit:function(e,t){},onComplete:function(e,t){}},t)t.hasOwnProperty(a)&&(this._settings[a]=t[a]);if(e.jquery?e=e[0]:"string"==typeof e&&(/^#.*/.test(e)&&(e=e.slice(1)),e=document.getElementById(e)),!e||1!==e.nodeType)throw new Error("Please make sure that you're passing a valid element");"A"==e.nodeName.toUpperCase()&&addEvent(e,"click",(function(e){e&&e.preventDefault?e.preventDefault():window.event&&(window.event.returnValue=!1)})),this._button=e,this._input=null,this._disabled=!1,this.enable(),this._rerouteClicks()},AjaxUpload.prototype={setData:function(e){this._settings.data=e},disable:function(){addClass(this._button,this._settings.disabledClass),this._disabled=!0;var e=this._button.nodeName.toUpperCase();"INPUT"!=e&&"BUTTON"!=e||this._button.setAttribute("disabled","disabled"),this._input&&this._input.parentNode&&(this._input.parentNode.style.visibility="hidden")},enable:function(){removeClass(this._button,this._settings.disabledClass),this._button.removeAttribute("disabled"),this._disabled=!1},_createInput:function(){var e=this,t=document.createElement("input");t.setAttribute("type","file"),t.setAttribute("name",this._settings.name),this._settings.multiple&&t.setAttribute("multiple","multiple"),addStyles(t,{position:"absolute",right:0,margin:0,padding:0,fontSize:"480px",fontFamily:"sans-serif",cursor:"pointer"});var a=document.createElement("div");if(addStyles(a,{display:"block",position:"absolute",overflow:"hidden",margin:0,padding:0,opacity:0,direction:"ltr",zIndex:2147483583}),"0"!==a.style.opacity){if(void 0===a.filters)throw new Error("Opacity not supported by the browser");a.style.filter="alpha(opacity=0)"}addEvent(t,"change",(function(){if(t&&""!==t.value){var a=fileFromPath(t.value);!1!==e._settings.onChange.call(e,a,getExt(a))?e._settings.autoSubmit&&e.submit():e._clearInput()}})),addEvent(t,"mouseover",(function(){addClass(e._button,e._settings.hoverClass)})),addEvent(t,"mouseout",(function(){removeClass(e._button,e._settings.hoverClass),removeClass(e._button,e._settings.focusClass),t.parentNode&&(t.parentNode.style.visibility="hidden")})),addEvent(t,"focus",(function(){addClass(e._button,e._settings.focusClass)})),addEvent(t,"blur",(function(){removeClass(e._button,e._settings.focusClass)})),a.appendChild(t),document.body.appendChild(a),this._input=t},_clearInput:function(){this._input&&(removeNode(this._input.parentNode),this._input=null,this._createInput(),removeClass(this._button,this._settings.hoverClass),removeClass(this._button,this._settings.focusClass))},_rerouteClicks:function(){var e=this;addEvent(e._button,"mouseover",(function(){if(!e._disabled){e._input||e._createInput();var t=e._input.parentNode;copyLayout(e._button,t),t.style.visibility="visible"}}))},_createIframe:function(){var e=getUID(),t=toElement('<iframe src="javascript:false;" name="'+e+'" />');return t.setAttribute("id",e),t.style.display="none",document.body.appendChild(t),t},_createForm:function(e){var t=this._settings,a=toElement('<form method="post" enctype="multipart/form-data"></form>');for(var n in a.setAttribute("action",t.action),a.setAttribute("target",e.name),a.style.display="none",document.body.appendChild(a),t.data)if(t.data.hasOwnProperty(n)){var i=document.createElement("input");i.setAttribute("type","hidden"),i.setAttribute("name",n),i.setAttribute("value",t.data[n]),a.appendChild(i)}return a},_getResponse:function(iframe,file){var toDeleteFlag=!1,self=this,settings=this._settings;addEvent(iframe,"load",(function(){if("javascript:'%3CHtml%3E%3C/html%3E';"!=iframe.src&&"javascript:'<html></html>';"!=iframe.src){var doc=iframe.contentDocument?iframe.contentDocument:window.frames[iframe.id].document,response;if(!doc.readyState||"complete"==doc.readyState)if(!doc.body||"false"!=doc.body.innerHTML)doc.XMLDocument?response=doc.XMLDocument:doc.body?(response=doc.body.innerHTML,settings.responseType&&"json"==settings.responseType.toLowerCase()&&(doc.body.firstChild&&"PRE"==doc.body.firstChild.nodeName.toUpperCase()&&(doc.normalize(),response=doc.body.firstChild.firstChild.nodeValue),response=response?eval("("+response+")"):{})):response=doc,settings.onComplete.call(self,file,response),toDeleteFlag=!0,iframe.src="javascript:'<html></html>';"}else toDeleteFlag&&setTimeout((function(){removeNode(iframe)}),0)}))},submit:function(){var e=this._settings;if(this._input&&""!==this._input.value){var t=fileFromPath(this._input.value);if(!1!==e.onSubmit.call(this,t,getExt(t))){var a=this._createIframe(),n=this._createForm(a);removeNode(this._input.parentNode),removeClass(this._button,this._settings.hoverClass),removeClass(this._button,this._settings.focusClass),n.appendChild(this._input),n.submit(),removeNode(n),n=null,removeNode(this._input),this._input=null,this._getResponse(a,t),this._createInput()}else this._clearInput()}}}}(),window.uploadModalObjects=window.uploadModalObjects||{},$((function(){openUploadModalDialog()})),window.displayUploadedFiles=function(e,t,a,n){var i=$("#"+t).val(),l="";if("[]"!=i&&""!=i){if(""!==i){var o=[];try{o=JSON.parse(i)}catch(e){}l='<table width="100%" class="question uploadedfiles">',l+="<thead>",l+="<tr>",l+='<th width="20%">&nbsp;</th>',0!=a&&(l+="<th>"+uploadLang.titleFld+"</th>"),0!=n&&(l+="<th>"+uploadLang.commentFld+"</th>"),l+="<th>"+uploadLang.filenameFld+'</th><th class="edit"></th></tr></thead><tbody>';var s=new Array("gif","jpeg","jpg","png","swf","psd","bmp","tiff","jp2","iff","bmp","xbm","ico");o.forEach((function(e,i){isValueInArray(s,e.ext)?l+='<tr><td class="upload image"><img src="'+uploadurl+"/filegetcontents/"+decodeURIComponent(e.filename)+'" class="uploaded" /></td>':l+='<tr><td class="upload placeholder"><div class="upload-placeholder" /></td>',0!=a&&(l+='<td class="upload title">'+e.title+"</td>"),0!=n&&(l+='<td class="upload comment">'+e.comment+"</td>"),l+='<td class="upload edit">'+decodeURIComponent(e.name)+'</td><td><a class="btn btn-primary" onclick="javascript:$(\'#upload_'+t+'\').click();"><span class="fa fa-pencil"></span>&nbsp;'+uploadLang.editFile+"</a></td></tr>"})),l+="</tbody></table>",$("#"+t+"_uploadedfiles").html(l)}}else $("#"+t+"_uploadedfiles").html(l)};var uploadHandler=function(e,t){var a=function(e,a,n){var i,o,s=n,r=new Array("gif","jpeg","jpg","png","swf","psd","bmp","tiff","jp2","iff","bmp","xbm","ico"),d=$('<li id="'+e+"_li_"+s+'" class="previewblock file-element"></li>'),p=$('<div class="file-preview"></div>');if(i=r,o=a.ext.toLowerCase(),i.reduce((function(e,t){return e||o.toLowerCase()==t.toLowerCase()}),!1)?p.append('<img src="'+t.uploadurl+"/filegetcontents/"+a.filename+'" class="uploaded" />'):p.append('<div class="upload-placeholder"></div>'),p.append('<span class="file-name">'+escapeHtml(decodeURIComponent(a.name))+"</span>"),1==$("#"+e+"_show_title").val()||1==$("#"+e+"_show_comment").val()){var u=$(""),c=$("");if(1==$("#"+e+"_show_title").val()){u=$('<div class="form-group"></div>');$('<label class="control-label col-xs-4"></label>').attr("for",e+"_title_"+s).text(t.uploadLang.titleFld).appendTo(u),$('<input class="form-control" type="text"/>').attr("id",e+"_title_"+s).val(a.title).wrap('<div class="input-container"></div>').appendTo(u)}if(1==$("#"+e+"_show_comment").val()){c=$('<div class="form-group"></div>');$('<label class="control-label col-xs-4"></label>').attr("for",e+"_comment_"+s).text(t.uploadLang.commentFld).appendTo(c),$('<input class="form-control" type="text"/>').attr("id",e+"_comment_"+s).val(a.comment).wrap('<div class="input-container"></div>').appendTo(c)}}var f=$('<div class="form-group"></div>').append($('<a class="btn btn-danger"></a>').html('<span class="fa fa-trash"></span>&nbsp;'+t.uploadLang.deleteFile).on("click",(function(){l(e,s)})).wrap('<div class="input-container text-center"></div>'));$("<fieldset></fieldset>").append(u).append(c).append(f).wrap('<div class="file-info"></div>').appendTo(p),$('<input type="hidden" />').attr("id",e+"_size_"+s).attr("value",a.size).appendTo(d),$('<input type="hidden" />').attr("id",e+"_name_"+s).attr("value",a.name).appendTo(d),$('<input type="hidden" />').attr("id",e+"_file_index_"+s).attr("value",s).appendTo(d),$('<input type="hidden" />').attr("id",e+"_filename_"+s).attr("value",a.filename).appendTo(d),$('<input type="hidden" />').attr("id",e+"_ext_"+s).attr("value",a.ext).appendTo(d),0===$("#"+e+"_li_"+s).length&&(d.append(p),$("#field"+e+"_listfiles").append(d))},n=function(){var n=t.sFieldName,i=$("#"+n+"_filecount").val();if($("#"+n+"_filecount").val(i),i>0){var l=$("#"+n).val(),o="";try{o=JSON.parse(l)}catch(e){}0==$("#field"+n+"_listfiles").length&&$('<ul id="field'+n+'_listfiles" class="files-list" />').insertAfter("#uploadstatus_"+e),$("#"+n+"_licount").val(i),o.forEach((function(e,t){a(n,e,t+1)}))}var s=$("#button_"+e);new AjaxUpload(s,{action:t.uploadurl+"/sid/"+surveyid+"/preview/"+t.questgrppreview+"/fieldname/"+n+"/",name:"uploadfile",data:{valid_extensions:$("#"+n+"_allowed_filetypes").val(),max_filesize:$("#"+n+"_maxfilesize").val(),preview:$("#preview").val(),surveyid:surveyid,fieldname:n,YII_CSRF_TOKEN:t.csrfToken},onSubmit:function(e,a){var i=parseInt($("#"+n+"_maxfiles").val()),l=parseInt($("#"+n+"_filecount").val()),o=$("#"+n+"_allowed_filetypes").val().split(",");return l>=i?($("#notice").html('<p class="alert alert-danger"><span class="fa fa-exclamation-circle"></span>&nbsp;'+uploadLang.errorNoMoreFiles+"</p>"),!1):0==o.reduce((function(e,t){return e||a.toLowerCase()===t}),!1)?($("#notice").html('<p class="alert alert-danger"><span class="fa fa-exclamation-circle"></span>&nbsp;'+uploadLang.errorOnlyAllowed.replace("%s",$("#"+n+"_allowed_filetypes").val())+"</p>"),!1):(s.text(t.uploadLang.uploading),this.disable(),void s.append('<i id="loading-icon-fielupload" class="fa fa-spinner fa-pulse fa-3x fa-fw"></i>'))},onComplete:function(e,i){s.text(uploadLang.selectfile),$("#loading-icon-fielupload").remove(),this.enable();try{var l=JSON.parse(i)}catch(e){return void $("body").html(i)}var o=parseInt($("#"+n+"_licount").val());if(o++,$("#"+n+"_licount").val(o),l.success){$("#notice").html('<p class="alert alert-success"><span class="fa fa-success"></span>&nbsp;'+l.msg+"</p>"),0==$("#field"+n+"_listfiles").length&&$("<ul id='field"+n+"_listfiles' class='files-list' />").insertAfter("#uploadstatus_"+t.qid),a(n,l,o);var r=parseInt($("#"+n+"_filecount").val()),d=parseInt($("#"+n+"_minfiles").val());r++;var p=parseInt($("#"+n+"_maxfiles").val());$("#"+n+"_filecount").val(r),r<d?$("#uploadstatus").html(t.uploadLang.errorNeedMore.replace("%s",d-r)):r<p?$("#uploadstatus").html(t.uploadLang.errorMoreAllowed.replace("%s",p-r)):$("#uploadstatus").html(t.uploadLang.errorMaxReached),r>=p&&$("#notice").html('<p class="alert alert-success"><span class="fa fa-check"></span>&nbsp;'+t.uploadLang.errorTooMuch+"</p>")}else $("#notice").html('<p class="alert alert-danger"><span class="fa fa-exclamation-circle"></span>&nbsp;'+l.msg+"</p>")}})};function i(e,t,a,n){for(var i=[],l=0,o=parseInt($("#"+e+"_licount").val()),s=1;s<=o;){if($("#"+e+"_li_"+s).is(":visible")){var r={title:1==$("#"+e+"_show_title").val()?$("#"+e+"_title_"+s).val():"",comment:1==$("#"+e+"_show_comment").val()?$("#"+e+"_comment_"+s).val():"",size:$("#"+e+"_size_"+s).val(),name:$("#"+e+"_name_"+s).val(),filename:$("#"+e+"_filename_"+s).val(),ext:$("#"+e+"_ext_"+s).val()};l+=1,i.push(r)}s++}$("#"+e).val(JSON.stringify(i)),function(e,t,a,n,i){$("#"+t+"_filecount").val(e),displayUploadedFiles(e,t,a,n,i)}(l,e,t,a,n)}var l=function(e,a){var n,i=$("#"+e+"_filename_"+a).val(),l=$("#"+e+"_name_"+a).val(),o=parseInt($("#"+e+"_filecount").val()),s=parseInt($("#"+e+"_licount").val());$.ajax({method:"POST",url:uploadurl,data:{delete:1,fieldname:e,filename:i,name:l,YII_CSRF_TOKEN:t.csrfToken}}).done((function(t){for($("#notice").html('<p class="alert alert-success"><span class="fa fa-check"></span>&nbsp;'+t+"</p>"),setTimeout((function(){$(".success").remove()}),5e3),$("#"+e+"_li_"+a).hide(),o--,$("#"+e+"_filecount").val(o),n=$("#"+e+"_file_index_"+a).val(),j=a;j<=s;j++)$("#"+e+"_li_"+j).is(":visible")&&($("#"+e+"_file_index_"+j).val(n),n++);var i=parseInt($("#"+e+"_minfiles").val()),l=parseInt($("#"+e+"_maxfiles").val());o<i?$("#uploadstatus").html(uploadLang.errorNeedMore.replace("%s",i-o)):$("#uploadstatus").html(uploadLang.errorMoreAllowed.replace("%s",l-o))}))};return{init:function(){n()},saveAndExit:function(e,t,a,n){var l=parseInt($("#"+e+"_filecount").val()),o=parseInt($("#"+e+"_minfiles").val());return 0!=o&&l<o&&showpopups?!!confirm(uploadLang.errorNeedMoreConfirm.replace("%s",o-l))&&(i(e,t,a,n),!0):(i(e,t,a,n),!0)}}};function escapeHtml(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}window.getUploadHandler=function(e,t){return window.currentUplaodHandler||(window.currentUplaodHandler=new uploadHandler(e,t)),window.currentUplaodHandler.init(),window.currentUplaodHandler}}));
//# sourceMappingURL=uploadquestion.min.js.map
